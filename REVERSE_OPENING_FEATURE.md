# 反向开仓功能说明

## 功能概述

新增**开仓方向配置**功能，支持两种套利策略：

### 1. 正向开仓（价差回归策略）- 默认
- **交易方向**：做多弱势币种，做空强势币种
- **盈利预期**：价差收窄，两个币种价格趋于一致
- **适用场景**：震荡行情或价格回归场景
- **示例**：BTC涨10%，ETH涨5%，价差+5% → 做多ETH，做空BTC

### 2. 反向开仓（价差扩大策略）- 新增
- **交易方向**：做多强势币种，做空弱势币种
- **盈利预期**：价差继续扩大，强者恒强、弱者恒弱
- **适用场景**：趋势明显的单边行情
- **示例**：BTC涨10%，ETH涨5%，价差+5% → 做多BTC，做空ETH

---

## 使用指南

### 创建机器人时

1. 在**创建机器人**页面，找到**"止盈止损配置"**部分
2. 选择**开仓方向**：
   - ○ **正向开仓**（价差回归策略）
   - ○ **反向开仓**（价差扩大策略）
3. 根据详细说明选择适合的策略
4. 完成其他配置后点击"创建机器人"

### 编辑已有机器人

1. 进入**机器人编辑**页面
2. **重要**：只有在机器人**停止状态**下才能修改开仓方向
3. 如果机器人正在运行，会显示提示：
   > ⚠️ 机器人运行中，无法修改开仓方向。请先停止机器人后再修改。
4. 停止机器人 → 修改开仓方向 → 保存修改 → 重新启动

### 查看机器人配置

在**机器人详情**页面可以看到当前的开仓方向配置，显示为：
- 🔵 **正向开仓（价差回归策略）**
- 🟡 **反向开仓（价差扩大策略）**

---

## 技术实现

### 后端修改

1. **数据模型** (`backend/app/models/bot_instance.py`)
   ```python
   reverse_opening: Mapped[bool] = mapped_column(
       Boolean, 
       default=False, 
       nullable=False
   )  # False=正向开仓, True=反向开仓
   ```

2. **API Schemas** (`backend/app/schemas/bot.py`)
   - `BotCreate` 添加 `reverse_opening: bool` 字段
   - `BotUpdate` 添加 `reverse_opening: Optional[bool]` 字段
   - `BotResponse` 添加 `reverse_opening: bool` 字段

3. **交易引擎** (`backend/app/core/bot_engine.py`)
   ```python
   # 如果启用反向开仓，反转交易方向
   if self.bot.reverse_opening:
       market1_side = 'sell' if market1_side == 'buy' else 'buy'
       market2_side = 'sell' if market2_side == 'buy' else 'buy'
   ```

### 前端修改

1. **TypeScript 类型** (`frontend/src/common/apis/bots/type.ts`)
   - 所有相关接口添加 `reverse_opening: boolean` 字段

2. **创建表单** (`frontend/src/pages/bots/BotCreate.vue`)
   - 添加单选框组件，带详细说明
   - 默认值：`false`（正向开仓）

3. **编辑表单** (`frontend/src/pages/bots/BotEdit.vue`)
   - 添加单选框组件
   - 运行中禁用修改，显示警告提示

4. **详情页面** (`frontend/src/pages/bots/BotDetail.vue`)
   - 显示开仓方向配置，使用 Tag 组件区分

---

## 数据库迁移

### 执行迁移脚本

```bash
# 1. 进入后端目录
cd backend

# 2. 激活虚拟环境（Windows）
venv\Scripts\activate

# 3. 运行迁移脚本
python add_reverse_opening_column.py
```

### 迁移内容

- 添加 `reverse_opening` 字段（BOOLEAN，NOT NULL，默认 FALSE）
- 所有现有机器人自动设置为正向开仓（`reverse_opening=False`）

---

## 策略选择建议

### 正向开仓（价差回归）

✅ **适用场景**：
- 两个币种长期相关性强
- 当前价差处于历史高位
- 市场处于震荡行情
- 基本面没有重大差异

❌ **不适用场景**：
- 某个币种有重大利好/利空消息
- 趋势明确的单边行情
- 两个币种基本面发生重大变化

### 反向开仓（价差扩大）

✅ **适用场景**：
- 某个币种有明确的趋势性行情
- 基本面出现重大差异（如升级、事件等）
- 价差处于历史低位但趋势向上
- 明显的强弱分化

❌ **不适用场景**：
- 价差已经处于历史极值
- 市场即将出现反转信号
- 两个币种高度相关且无差异

---

## 风险提示

1. **策略选择错误风险**
   - 错误判断市场趋势可能导致亏损
   - 建议充分研究市场和币种基本面

2. **运行中不可切换**
   - 已开仓位后切换策略会导致逻辑混乱
   - 必须先平仓停止，再修改配置

3. **回测验证**
   - 建议先用小资金或模拟账户测试
   - 观察不同策略在不同市场环境下的表现

4. **止盈止损设置**
   - 反向策略可能需要更宽松的止损设置
   - 根据实际情况调整风险参数

---

## 常见问题

### Q1: 为什么运行中不能修改开仓方向？

**A**: 因为已有持仓是按原策略开的，切换策略会导致：
- 持仓方向与策略不匹配
- 止盈止损逻辑出现预期外的行为
- 用户容易操作失误

正确流程：停止 → 平仓 → 修改配置 → 重新启动

### Q2: 修改开仓方向会影响历史数据吗？

**A**: 不会。历史订单、持仓、盈亏记录都保持不变，只影响下次启动后的新开仓。

### Q3: 两种策略的止盈逻辑有区别吗？

**A**: 
- **回归止盈模式**：判断逻辑相同，都是价差变化达到目标即止盈
- **仓位止盈模式**：完全相同，基于总盈亏百分比

### Q4: 可以同时运行正向和反向两个机器人吗？

**A**: 可以！你可以创建两个机器人，分别使用不同的策略，分散风险。

### Q5: 如何判断应该用哪种策略？

**A**: 建议参考：
1. 查看历史价差走势图
2. 分析币种基本面差异
3. 考虑当前市场环境（趋势/震荡）
4. 参考技术指标（RSI、MACD等）
5. 先小仓位测试，观察效果

---

## 更新日志

**版本**: v1.1.0  
**日期**: 2025-01-XX

### 新增功能
- ✅ 支持正向/反向开仓方向配置
- ✅ 前端表单添加详细策略说明
- ✅ 编辑时运行状态检查和提示
- ✅ 详情页显示当前策略配置

### 修改文件
- 后端：4个文件
- 前端：3个文件
- 数据库：1个迁移脚本

---

## 联系支持

如有问题或建议，请提交 Issue 或联系开发团队。

**祝交易顺利！** 🚀
