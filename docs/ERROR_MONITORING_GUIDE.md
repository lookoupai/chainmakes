# 错误监控工具使用指南

## 📋 概述

在机器人运行过程中，后端日志每5秒刷新一次，人工查看错误日志非常困难。我们开发了一个专门的错误监控工具，可以：

- ✅ **实时监控**：自动检测新的错误日志
- ✅ **分类统计**：按错误类型自动分类统计
- ✅ **持久化记录**：将错误保存到独立文件
- ✅ **清晰摘要**：定期生成易读的错误摘要报告

---

## 🚀 快速启动

### Windows 用户

双击运行项目根目录的 `启动错误监控.bat` 文件即可。

### 手动启动

```bash
cd backend
python scripts/monitor_trading_errors.py
```

---

## 📊 监控界面说明

### 实时监控输出

监控工具会实时显示新发现的错误：

```
================================================================================
[17:15:30] 发现 1 个新错误!
================================================================================

┌─ 机器人 [10] OKX 模拟盘测试机器人
├─ 时间: 2025-10-07 17:15:30
├─ 类型: API错误
└─ 错误: 开仓失败: API request timeout

[17:15:35] ✓ 无新错误
```

### 无错误状态

当没有新错误时，会显示实时状态：

```
[17:15:40] ✓ 无新错误
```

---

## 📁 生成的文件

### 1. 错误日志文件

**位置**: `backend/logs/trading_errors.log`

**内容**: 详细的错误记录，包括：
- 时间戳
- 机器人ID和名称
- 错误类型
- 完整错误信息

**示例**:
```
────────────────────────────────────────────────────────────────────────────────
时间: 2025-10-07 17:15:30
机器人ID: 10
机器人名称: OKX 模拟盘测试机器人
错误类型: API错误
错误信息: 开仓失败: API request timeout
────────────────────────────────────────────────────────────────────────────────
```

### 2. 错误摘要文件

**位置**: `backend/logs/error_summary.txt`

**更新频率**: 每50秒自动生成一次

**内容**: 统计分析报告，包括：
- 运行中的机器人列表
- 各机器人的错误统计
- 错误类型分布
- 最近的错误列表

**示例**:
```
================================================================================
错误监控摘要报告
生成时间: 2025-10-07 17:20:00
================================================================================

运行中的机器人: 1 个
  - [10] OKX 模拟盘测试机器人

错误统计:
────────────────────────────────────────────────────────────────────────────────

机器人 ID: 10
  总错误数: 5
  错误类型分布:
    - API错误: 3 次 (60.0%)
    - 网络错误: 2 次 (40.0%)

  最近的错误 (最多3条):
    [17:18:45] 网络错误
      执行循环错误: Connection timeout
    [17:19:12] API错误
      开仓失败: Invalid API response
    [17:19:50] API错误
      开仓失败: Rate limit exceeded
────────────────────────────────────────────────────────────────────────────────
```

---

## 🏷️ 错误类型分类

监控工具会自动将错误分为以下类型：

| 错误类型 | 触发关键词 | 说明 |
|---------|----------|------|
| **API错误** | api, request | API调用相关错误 |
| **网络错误** | network, timeout, connection | 网络连接问题 |
| **交易错误** | order, trade | 下单或交易执行失败 |
| **余额不足** | balance, insufficient | 账户余额不足 |
| **持仓错误** | position | 持仓管理相关错误 |
| **价格/价差错误** | price, spread | 价格获取或价差计算错误 |
| **数据库错误** | database, db | 数据库操作失败 |
| **其他错误** | - | 未分类的其他错误 |

---

## 🔧 使用场景

### 场景1: 监控新机器人首次运行

```bash
# 1. 启动后端服务
./启动后端.bat

# 2. 在另一个终端启动错误监控
./启动错误监控.bat

# 3. 在前端启动机器人

# 4. 观察监控工具输出，确认没有错误
```

### 场景2: 排查间歇性错误

```bash
# 1. 启动错误监控，让它持续运行
./启动错误监控.bat

# 2. 等待一段时间（如1小时）

# 3. 查看 backend/logs/error_summary.txt
#    分析错误类型分布，找出主要问题

# 4. 查看 backend/logs/trading_errors.log
#    获取详细的错误信息和时间线
```

### 场景3: 验证修复效果

```bash
# 1. 修复代码后，清空旧日志
rm backend/logs/trading_errors.log
rm backend/logs/error_summary.txt

# 2. 重启后端和错误监控

# 3. 运行机器人一段时间

# 4. 确认不再出现相同类型的错误
```

---

## 💡 最佳实践

### 1. 持续监控

建议在开发和测试期间，始终保持错误监控工具运行。

### 2. 定期检查摘要

每隔一段时间（如1小时）查看一次 `error_summary.txt`，了解整体错误情况。

### 3. 错误日志归档

如果日志文件过大，可以定期归档：

```bash
# Windows PowerShell
Move-Item backend/logs/trading_errors.log backend/logs/trading_errors_backup_20251007.log
```

### 4. 配合后端日志

错误监控工具只记录错误级别的日志。如需查看完整的调试信息，仍需查看后端主日志。

---

## 🐛 常见问题

### Q1: 监控工具显示数据库连接错误

**原因**: 后端服务未启动

**解决**: 先启动后端服务 `./启动后端.bat`，再启动监控工具

### Q2: 没有生成日志文件

**原因**: 没有检测到错误，或日志目录权限问题

**解决**: 
- 确认机器人确实出现了错误
- 检查 `backend/logs/` 目录是否有写入权限

### Q3: 监控工具占用太多资源

**原因**: 检查频率过高或错误日志过多

**解决**: 
- 可以修改 `monitor_trading_errors.py` 中的 `await asyncio.sleep(5)` 改为更大的值
- 定期清理历史日志

---

## 🔄 停止监控

按 `Ctrl+C` 即可停止监控。停止时会自动生成最终的错误摘要报告。

---

## 📝 后续改进计划

- [ ] 支持邮件/微信通知严重错误
- [ ] 增加错误趋势图表
- [ ] 支持自定义错误过滤规则
- [ ] 增加错误自动诊断建议

---

## 📞 技术支持

如有问题或建议，请查看项目文档或联系开发团队。