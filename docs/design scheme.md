# 加密货币价差套利机器人（Spread Arbitrage Bot）技术设计方案

本机器人采用双币对冲策略，核心在于锚定两个选定市场（Market 1, Market 2）的**涨跌比例差**，通过做空涨幅高者，做多涨幅低者，利用价差回归的特性实现盈利。

## I. 初始化与基础参数配置

机器人启动时，必须从用户界面获取以下配置参数并进行初始化：

### 1. 时间和订单类型

| 参数名称 | 描述 | 来源 |
| :--- | :--- | :--- |
| **统计开始时间（UTC）** | 设定计算涨跌幅的基准时间点。**必须使用世界统一时间（UTC）**，以确保机器人的数据与图表（如 TradingView）一致。在这个时间点，两个市场的涨幅比例都被视为 0%。 | |
| **开仓订单类型** | 决定开仓时使用的订单类型（例如：Market/市价）。 | |
| **平仓订单类型** | 决定平仓时使用的订单类型（例如：Market/市价）。 | |

### 2. 市场与资金管理

| 参数名称 | 描述 | 来源 |
| :--- | :--- | :--- |
| **市场 1 / 市场 2** | 用户选定的永续合约对（例如 GALA-USDT 和 CHZ-USDT）。 | |
| **交易方向** | 初始启动时需指定市场 1 和市场 2 的交易方向（BUY/做多 或 SELL/做空）。**此方向在循环结束后会被重置**。 | |
| **每单投资额** | 每次下单的基础投资金额（例如 25 USD）。 | |
| **最大持仓面值** | 允许持有的双币种总仓位价值上限（例如 250 USD）。如果使用“加仓倍投”，此值可能需要相应调高。 | |
| **账户最大杠杆** | 账户设置的杠杆倍数（例如 1x, 3x, 5x, 10x, 20x）。 | |

## II. 交易执行逻辑：开仓与加仓（DCA）

机器人通过持续监控两个市场相对于“统计开始时间”的涨跌比例差来进行开仓和加仓。

### 1. 开仓阈值设定

*   **下单次数**：设定机器人允许的最大加仓次数（例如 6 次）。达到最大次数后，机器人不再进行加仓，等待价差回归平仓。
*   **下单价差**：这是触发每次加仓的价差百分比。
    *   **核心实现逻辑：** 机器人检测的价差是**相对上次成交之后**作为比较，而不是相对于“统计开始时间”的绝对价差。
    *   **示例：** 如果第三次成交时绝对价差为 3%，第四次设定的下单价差为 1%，则价差达到 4% 时才会触发第四次下单。
    *   **自定义设置：** 允许用户为每次加仓设置不同的价差值（例如第 1 次 1%，第 2 次 2%，第 3 次 3%等）。建议末尾几次加仓的价差设定更高，以应对价差突然大幅拉大的情况。

### 2. 加仓量控制（倍投）

*   **加仓倍投倍数：** 机器人必须支持设置每次加仓相对于**“每单投资额”**的倍数。
*   **倍投目的：** 采用倍投下单能够使止盈点位明显上移，更容易止盈。
*   **实现细节：** 每次下单量 = 每单投资额 $\times$ 对应的加仓倍投倍数。总投资额（最大持仓面值）必须大于所有加仓订单面值的总和。

### 3. 开仓方向确定

当价差达到开仓阈值时，机器人立即执行对冲操作：
*   **做空**涨幅比例更高的币种（上方市场）。
*   **做多**涨幅比例更低的币种（下方市场）。

## III. 止盈与止损逻辑

### 1. 止盈模式选择与实现

机器人提供两种止盈模式，由用户选择。

| 止盈模式 | 触发条件 | 逻辑要点 | 来源 |
| :--- | :--- | :--- | :--- |
| **回归止盈** | **（此次循环的开仓价差 - 现在的绝对价差）** $\ge$ **止盈比例** 时触发。这个差值即为“从上次开仓到现在的价差”。 | 如果用户相信两个市场的价差最终会回归到开仓时的价差，则选用此模式。**所有止盈点位都参照第一次加仓的价格来计算**。 | |
| **仓位止盈** | **（多空两个仓位浮盈之和 / 总投资额）** $\times$ 100% $\ge$ **止盈比例** 时触发。 | 理解简单，更容易止盈，适用于波动较大的市场。 | |

*   **通用止盈点位计算：** 无论加仓多少次，所有止盈点位（包括提前止盈、交叉止盈、延迟止盈）都是针对**第一次加仓的价格**来计算的。
*   **止盈比例调整：** 止盈比例可设置为 0 或负数，以允许尽快平仓。若设定为 0 或负数，必须确保有未平仓订单，并且需要同时开启“平仓后暂停”，以避免机器人立即以亏损状态开启下一循环。

### 2. 止损逻辑

*   **仓位止损比例**：设定整个仓位可承受的最大亏损比例（例如 10%）。
*   **触发条件**：当**整个仓位的亏损**（即两个币种仓位的总和）达到设定的百分比时，触发止损，平仓离场。

## IV. 循环与状态控制

### 1. 交易循环

*   机器人在完成开仓和平仓的一个循环后，将自动开启下一个循环。
*   **方向重置：** 止盈平仓后，两个市场的交易方向（多空）会被设定为**空**。
*   **重新开仓：** 机器人等待市场再次走出趋势并达到设定的**开仓价差**后，重新确定上方市场为做空、下方市场为做多，并同时开仓，重复加仓和止盈逻辑。

### 2. 暂停机制

*   **永不暂停：** 机器人止盈后自动进入下一循环。
*   **平仓后暂停（触发暂停）：** 如果用户选择此项，机器人在完成止盈平仓后将停止运行，等待用户重新配置参数或手动启动。