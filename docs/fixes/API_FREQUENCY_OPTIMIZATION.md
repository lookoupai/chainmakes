# API è¯·æ±‚é¢‘ç‡ä¼˜åŒ–è¯´æ˜

## ä¼˜åŒ–ç›®æ ‡

é™ä½ OKX API è¯·æ±‚é¢‘ç‡ï¼Œé¿å…ï¼š
- è§¦å‘ API é¢‘ç‡é™åˆ¶
- ç½‘ç»œè¿æ¥ä¸ç¨³å®šå¯¼è‡´çš„é”™è¯¯
- æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜
- æé«˜ç³»ç»Ÿæ•´ä½“ç¨³å®šæ€§

## ä¼˜åŒ–å‰çš„çŠ¶æ€

### è¯·æ±‚é¢‘ç‡åˆ†æ

**å•ä¸ªæœºå™¨äººæ¯5ç§’å¾ªç¯ä¸€æ¬¡ï¼š**
- `get_ticker()` Ã— 2æ¬¡ï¼ˆmarket1 å’Œ market2ï¼‰
- `get_position()` Ã— Næ¬¡ï¼ˆæ¯ä¸ªæŒä»“ä¸€æ¬¡ï¼‰
- æ¯å°æ—¶ API è¯·æ±‚ï¼š**çº¦ 1,440+ æ¬¡**

**å¤šä¸ªæœºå™¨äººåœºæ™¯ï¼š**
- 3ä¸ªæœºå™¨äººï¼š**4,320+ æ¬¡/å°æ—¶**
- 5ä¸ªæœºå™¨äººï¼š**7,200+ æ¬¡/å°æ—¶**

### æ½œåœ¨é—®é¢˜

1. **API é™æµé£é™©**ï¼šOKX æœ‰è¯·æ±‚é¢‘ç‡é™åˆ¶
2. **ç½‘ç»œç¨³å®šæ€§**ï¼šé¢‘ç¹è¯·æ±‚å®¹æ˜“é‡åˆ°è¿æ¥é—®é¢˜
3. **èµ„æºæµªè´¹**ï¼šå®æ—¶ä»·æ ¼å˜åŒ–ä¸éœ€è¦5ç§’æ›´æ–°ä¸€æ¬¡
4. **æœåŠ¡å™¨å‹åŠ›**ï¼šæ•°æ®åº“å†™å…¥é¢‘ç¹

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å¢åŠ ä¸»å¾ªç¯é—´éš” â±ï¸

**ä¿®æ”¹å‰ï¼š**
```python
await asyncio.sleep(5)  # æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
```

**ä¿®æ”¹åï¼š**
```python
await asyncio.sleep(10)  # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ï¼Œé™ä½APIè¯·æ±‚é¢‘ç‡
```

**æ•ˆæœï¼š**
- API è¯·æ±‚é¢‘ç‡é™ä½ **50%**
- å•æœºå™¨äººï¼š**~720 æ¬¡/å°æ—¶**
- å¯¹å¥—åˆ©ç­–ç•¥å½±å“æå°ï¼ˆä»·å·®å˜åŒ–ä¸ä¼šå¤ªå¿«ï¼‰

---

### 2. æ·»åŠ ä»·æ ¼ç¼“å­˜æœºåˆ¶ ğŸ’¾

**å®ç°æ–¹å¼ï¼š**
```python
# ä»·æ ¼ç¼“å­˜æœºåˆ¶
self._price_cache = {}
self._price_cache_time = {}
self._price_cache_ttl = 5  # ç¼“å­˜5ç§’

async def _get_market_price(self, symbol: str) -> Decimal:
    """è·å–å¸‚åœºä»·æ ¼ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    current_time = time.time()

    # æ£€æŸ¥ç¼“å­˜
    if symbol in self._price_cache:
        cache_time = self._price_cache_time.get(symbol, 0)
        if current_time - cache_time < self._price_cache_ttl:
            # ç¼“å­˜æœ‰æ•ˆï¼Œç›´æ¥è¿”å›
            return self._price_cache[symbol]

    # ç¼“å­˜å¤±æ•ˆï¼Œä»äº¤æ˜“æ‰€è·å–
    ticker = await self.exchange.get_ticker(symbol)
    price = ticker['last_price']

    # æ›´æ–°ç¼“å­˜
    self._price_cache[symbol] = price
    self._price_cache_time[symbol] = current_time

    return price
```

**æ•ˆæœï¼š**
- åœ¨ä¸€ä¸ªå¾ªç¯å‘¨æœŸå†…ï¼ŒåŒä¸€äº¤æ˜“å¯¹åªè¯·æ±‚ä¸€æ¬¡
- è¿›ä¸€æ­¥é™ä½ **30-40%** çš„è¯·æ±‚é‡
- ä»·æ ¼æ•°æ®å»¶è¿Ÿ < 5ç§’ï¼ˆå®Œå…¨å¯æ¥å—ï¼‰

---

### 3. ä¼˜åŒ–æŒä»“æ›´æ–°é¢‘ç‡ ğŸ“Š

**ä¿®æ”¹å‰ï¼š**
```python
# æ¯ä¸ªå¾ªç¯éƒ½æ›´æ–°æŒä»“ï¼ˆ5ç§’ä¸€æ¬¡ï¼‰
await self.update_position_prices()
```

**ä¿®æ”¹åï¼š**
```python
# æŒä»“æ›´æ–°é¢‘ç‡æ§åˆ¶
self._position_update_counter = 0
self._position_update_interval = 3  # æ¯3ä¸ªå¾ªç¯æ›´æ–°ä¸€æ¬¡

# æ¯3ä¸ªå¾ªç¯æ‰æ›´æ–°ä¸€æ¬¡æŒä»“ï¼ˆ30ç§’ä¸€æ¬¡ï¼‰
self._position_update_counter += 1
if self._position_update_counter >= self._position_update_interval:
    self._position_update_counter = 0
    await self.update_position_prices()
else:
    logger.debug(f"è·³è¿‡æŒä»“æ›´æ–°ï¼ˆ{self._position_update_counter}/{self._position_update_interval}ï¼‰")
```

**æ•ˆæœï¼š**
- æŒä»“æ›´æ–°ä» 5ç§’ä¸€æ¬¡ â†’ 30ç§’ä¸€æ¬¡
- é™ä½ **83%** çš„æŒä»“æŸ¥è¯¢è¯·æ±‚
- ç›ˆäºæ˜¾ç¤ºå»¶è¿Ÿ < 30ç§’ï¼ˆå¯æ¥å—ï¼‰

---

## ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### API è¯·æ±‚é¢‘ç‡å¯¹æ¯”è¡¨

| åœºæ™¯ | ä¼˜åŒ–å‰ï¼ˆ5ç§’å¾ªç¯ï¼‰ | ä¼˜åŒ–åï¼ˆ10ç§’å¾ªç¯ + ç¼“å­˜ï¼‰ | å‡å°‘æ¯”ä¾‹ |
|------|------------------|------------------------|----------|
| **å•æœºå™¨äºº/å°æ—¶** | ~1,440 æ¬¡ | ~360 æ¬¡ | **â†“ 75%** |
| **å•æœºå™¨äºº/å¤©** | ~34,560 æ¬¡ | ~8,640 æ¬¡ | **â†“ 75%** |
| **3ä¸ªæœºå™¨äºº/å°æ—¶** | ~4,320 æ¬¡ | ~1,080 æ¬¡ | **â†“ 75%** |
| **5ä¸ªæœºå™¨äºº/å°æ—¶** | ~7,200 æ¬¡ | ~1,800 æ¬¡ | **â†“ 75%** |

### å…·ä½“æ”¹è¿›

| ä¼˜åŒ–é¡¹ | æ”¹è¿›æ•ˆæœ | å¯¹ç­–ç•¥å½±å“ |
|--------|---------|----------|
| ä¸»å¾ªç¯é—´éš” 10ç§’ | â†“ 50% è¯·æ±‚ | âœ… æ— å½±å“ |
| ä»·æ ¼ç¼“å­˜ 5ç§’ | â†“ 30-40% è¯·æ±‚ | âœ… æ— å½±å“ï¼ˆå»¶è¿Ÿ<5sï¼‰ |
| æŒä»“æ›´æ–° 30ç§’ | â†“ 83% æŒä»“æŸ¥è¯¢ | âœ… å¯æ¥å—ï¼ˆå»¶è¿Ÿ<30sï¼‰ |
| **æ€»ä½“æ•ˆæœ** | **â†“ 75% æ€»è¯·æ±‚** | âœ… å¯¹äº¤æ˜“ç­–ç•¥å‡ ä¹æ— å½±å“ |

---

## é…ç½®å‚æ•°è¯´æ˜

### å¯è°ƒæ•´çš„å‚æ•°

åœ¨ `bot_engine.py` ä¸­å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š

```python
# ä¸»å¾ªç¯é—´éš”ï¼ˆç§’ï¼‰
await asyncio.sleep(10)  # å»ºè®®èŒƒå›´ï¼š10-30ç§’

# ä»·æ ¼ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
self._price_cache_ttl = 5  # å»ºè®®èŒƒå›´ï¼š3-10ç§’

# æŒä»“æ›´æ–°é—´éš”ï¼ˆå¾ªç¯æ¬¡æ•°ï¼‰
self._position_update_interval = 3  # å»ºè®®èŒƒå›´ï¼š2-6æ¬¡ï¼ˆå³20-60ç§’ï¼‰
```

### å‚æ•°é€‰æ‹©å»ºè®®

| äº¤æ˜“é£æ ¼ | ä¸»å¾ªç¯é—´éš” | ä»·æ ¼ç¼“å­˜TTL | æŒä»“æ›´æ–°é—´éš” |
|---------|-----------|------------|------------|
| **æ¿€è¿›å‹** | 10ç§’ | 3ç§’ | 2æ¬¡å¾ªç¯ |
| **å¹³è¡¡å‹** | 10ç§’ | 5ç§’ | 3æ¬¡å¾ªç¯ | âœ… å½“å‰é…ç½®
| **ä¿å®ˆå‹** | 15-20ç§’ | 8-10ç§’ | 4-6æ¬¡å¾ªç¯ |

---

## é£é™©è¯„ä¼°

### âœ… ä½é£é™©

1. **ä»·å·®ç›‘æ§å»¶è¿Ÿ**
   - å»¶è¿Ÿï¼š5-10ç§’
   - å½±å“ï¼šæå°ï¼ˆå¥—åˆ©ä»·å·®ä¸ä¼šç¬é—´æ¶ˆå¤±ï¼‰

2. **æŒä»“ç›ˆäºæ˜¾ç¤ºå»¶è¿Ÿ**
   - å»¶è¿Ÿï¼š<30ç§’
   - å½±å“ï¼šä»…å½±å“æ˜¾ç¤ºï¼Œä¸å½±å“äº¤æ˜“å†³ç­–

### âš ï¸ éœ€è¦æ³¨æ„

1. **å¿«é€Ÿæ³¢åŠ¨å¸‚åœº**
   - åœ¨æç«¯è¡Œæƒ…ä¸‹ï¼Œå¯èƒ½é”™è¿‡å¿«é€Ÿä»·å·®æœºä¼š
   - å»ºè®®ï¼šç›‘æ§å¸‚åœºæ³¢åŠ¨æ€§ï¼Œå¿…è¦æ—¶è°ƒæ•´å‚æ•°

2. **å¤šæœºå™¨äººå¹¶å‘**
   - è™½ç„¶é™ä½äº†75%è¯·æ±‚ï¼Œä½†å¤šæœºå™¨äººä»éœ€æ³¨æ„æ€»é‡
   - å»ºè®®ï¼š5ä¸ªä»¥å†…æœºå™¨äººåŒæ—¶è¿è¡Œ

---

## ç›‘æ§å»ºè®®

### æ—¥å¿—ç›‘æ§

è§‚å¯Ÿä»¥ä¸‹æ—¥å¿—åˆ¤æ–­ä¼˜åŒ–æ•ˆæœï¼š

```bash
# 1. ç¼“å­˜å‘½ä¸­æ—¥å¿—
ä½¿ç”¨ç¼“å­˜ä»·æ ¼: BTC/USDT:USDT = 65432.5

# 2. æŒä»“æ›´æ–°è·³è¿‡æ—¥å¿—
è·³è¿‡æŒä»“æ›´æ–°ï¼ˆ1/3ï¼‰
è·³è¿‡æŒä»“æ›´æ–°ï¼ˆ2/3ï¼‰

# 3. å¾ªç¯æ‰§è¡Œæ—¶é—´
[BotEngine] Bot 11 ç¬¬ 100 æ¬¡å¾ªç¯å®Œæˆï¼Œç­‰å¾…10ç§’
```

### æ€§èƒ½æŒ‡æ ‡

```python
# æ¯100æ¬¡å¾ªç¯ä¼šè¾“å‡ºæ€§èƒ½ç»Ÿè®¡
[BotEngine] Bot 11 æ€§èƒ½ç»Ÿè®¡ -
  æ€»å¾ªç¯: 100,
  å¹³å‡è€—æ—¶: 0.856s,  # åº”è¯¥ < 2ç§’
  æœ€è¿‘100æ¬¡å¹³å‡: 0.823s,
  æœ¬æ¬¡è€—æ—¶: 0.905s
```

**æ€§èƒ½æ ‡å‡†ï¼š**
- å•æ¬¡å¾ªç¯è€—æ—¶ï¼š**< 2ç§’**ä¸ºä¼˜ç§€
- å¹³å‡è€—æ—¶ï¼š**< 1ç§’**ä¸ºç†æƒ³

---

## å›æ»šæ–¹æ¡ˆ

å¦‚æœå‘ç°ä¼˜åŒ–åç­–ç•¥è¡¨ç°ä¸ä½³ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

### æ–¹æ¡ˆ 1ï¼šæ¢å¤5ç§’å¾ªç¯

```python
# bot_engine.py ç¬¬110è¡Œ
await asyncio.sleep(5)  # æ”¹å›5ç§’
```

### æ–¹æ¡ˆ 2ï¼šç¦ç”¨ä»·æ ¼ç¼“å­˜

```python
# bot_engine.py ç¬¬66è¡Œ
self._price_cache_ttl = 0  # è®¾ä¸º0ç¦ç”¨ç¼“å­˜
```

### æ–¹æ¡ˆ 3ï¼šå¢åŠ æŒä»“æ›´æ–°é¢‘ç‡

```python
# bot_engine.py ç¬¬70è¡Œ
self._position_update_interval = 1  # æ¯ä¸ªå¾ªç¯éƒ½æ›´æ–°
```

---

## åç»­ä¼˜åŒ–å»ºè®®

### 1. WebSocket å®æ—¶ä»·æ ¼æ¨é€
- æ›¿ä»£ REST API è½®è¯¢
- çœŸæ­£çš„å®æ—¶ä»·æ ¼ï¼ˆå»¶è¿Ÿ < 100msï¼‰
- å¤§å¹…é™ä½ API è¯·æ±‚é‡

### 2. æ‰¹é‡ API è¯·æ±‚
- ä½¿ç”¨ OKX çš„æ‰¹é‡æŸ¥è¯¢æ¥å£
- ä¸€æ¬¡è¯·æ±‚è·å–å¤šä¸ªäº¤æ˜“å¯¹ä»·æ ¼

### 3. æ™ºèƒ½é—´éš”è°ƒæ•´
- æ ¹æ®ä»·å·®å˜åŒ–åŠ¨æ€è°ƒæ•´å¾ªç¯é—´éš”
- ä»·å·®æ¥è¿‘é˜ˆå€¼æ—¶åŠ å¿«æ£€æŸ¥é¢‘ç‡

### 4. è¯·æ±‚é˜Ÿåˆ—ç®¡ç†
- å…¨å±€è¯·æ±‚é˜Ÿåˆ—æ§åˆ¶
- é¿å…å¤šæœºå™¨äººåŒæ—¶è¯·æ±‚

---

## æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•

- [ ] ä»·æ ¼è·å–æ­£å¸¸
- [ ] ç¼“å­˜æœºåˆ¶ç”Ÿæ•ˆ
- [ ] æŒä»“æ›´æ–°æ­£å¸¸
- [ ] å¼€ä»“/å¹³ä»“åŠŸèƒ½æ­£å¸¸

### 2. æ€§èƒ½æµ‹è¯•

- [ ] å•æœºå™¨äººè¿è¡Œç¨³å®š
- [ ] å¤šæœºå™¨äººå¹¶å‘ç¨³å®š
- [ ] API è¯·æ±‚é¢‘ç‡ç¬¦åˆé¢„æœŸ
- [ ] æ— ç½‘ç»œé”™è¯¯å¢åŠ 

### 3. ç­–ç•¥æµ‹è¯•

- [ ] ä»·å·®ç›‘æ§å‡†ç¡®
- [ ] å¼€ä»“ä¿¡å·ä¸é—æ¼
- [ ] æ­¢ç›ˆæ­¢æŸæ­£å¸¸è§¦å‘
- [ ] æ•´ä½“æ”¶ç›Šæœªå—å½±å“

---

## æ›´æ–°æ—¥å¿—

- **2025-10-11**
  - ä¸»å¾ªç¯é—´éš”ä»5ç§’å¢åŠ åˆ°10ç§’
  - æ·»åŠ ä»·æ ¼ç¼“å­˜æœºåˆ¶ï¼ˆ5ç§’TTLï¼‰
  - æŒä»“æ›´æ–°é¢‘ç‡ä»5ç§’é™ä½åˆ°30ç§’
  - é¢„è®¡é™ä½75% APIè¯·æ±‚é‡

---

## ç›¸å…³æ–‡ä»¶

- `backend/app/core/bot_engine.py` - æœºå™¨äººæ ¸å¿ƒå¼•æ“
- `backend/app/exchanges/okx_exchange.py` - OKX äº¤æ˜“æ‰€é€‚é…å™¨
- `docs/NETWORK_RETRY_FIX.md` - ç½‘ç»œé‡è¯•æœºåˆ¶æ–‡æ¡£
